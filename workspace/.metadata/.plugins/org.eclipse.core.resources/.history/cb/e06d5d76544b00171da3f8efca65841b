<!DOCTYPE html>

<html xmlns:th="http://www.thymeleaf.org"
	xmlns:dt="http://github.com/dandelion/datatables"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorator="filter-layout" ddl:bundle-includes="bootstrapValidator,select2">

	<head>
		<title>Person</title>
			
		<style>
			.invoice {
			    margin: 0;
			}
		</style>
	</head>
	<body th:with="rightMenu='persons'">
	
		<section layout:fragment="top-header">
			<div class="fixed-header">
				<div class="ui-header-image pull-left">
					<img data-src="holder.js/140x140" class="img-circle" alt="140x140"
						src="resources/images/profile.png"
						th:src="@{/resources/images/profile.png}"
						style="width: 48px; height: 48px;" />
				</div>
				<div class="ui-header-title">
					<div class="split-left">
						<h3>
							<small>Person</small>
						</h3>
						<h3 th:text="${person.nameLocal}"></h3>
					</div>
					<div class="split-right" th:if="${mode != 'viewPerson'}">
						<button class="btn btn-success" th:text="#{button.save}" id="createPersonBtn"></button>
					</div>
				</div>
			</div>
		</section>
		
		<section class="content" layout:fragment="content">
				<div th:if="${result}" th:object="${result}">
       				<div th:if="*{status != 'success'}" th:include="errors :: error-content" th:remove="tag"></div>
				</div>
				<div class="box box-primary">
					<div class="box-header with-border">
						<h3 class="box-title">
							<i class="fa fa-user"></i> Person
						</h3>
					</div>
				<div class="box-body">
					<form id="createPersonForm" class="form-horizontal" role="form" method="post" th:object="${person}">
						<div class="callout callout-danger hide"><h4></h4></div>
						<input type="submit" value="FormSubmitBtn" id="submitBtn" style="display: none;" />
						<fieldset>
							<input type="hidden" th:field="*{id}" />
						</fieldset>
						<div class="row">
							<div class="col-md-6">
								<div class="form-group" th:if="${mode != 'createPerson'}">
									<label class="col-sm-3 control-label" th:text="#{person.active}"></label>
									<div class="col-sm-7">
										<input class="form-control" type="checkbox" th:field="*{active}" th:readonly="${mode == 'viewPerson'}"/>
									</div>
								</div>
							</div>
						</div>
						<div class="row">
							<div class="col-md-6">
								<div class="form-group">
									<label class="col-sm-3 control-label" th:text="#{person.type}"></label>
									<div class="col-sm-7">
										<label  class="radio-inline" th:each="type : ${T(com.parvanpajooh.personmanagement.model.enums.PersonType).values()}" >
											<input class="iradio_minimal" type="radio" th:field="*{type}" th:value="${type}" th:text="#{__${#strings.toLowerCase(type.toString())}__}" />
										</label>
									</div>
								</div>
							</div>
						</div>
						<div class="row" >
							<div class="col-md-6" >
								<div class="form-group">
									<label class="col-sm-3 control-label" th:inline="text">[[#{organization}]]<span class="reqired"> *</span></label>
									<div class="col-sm-7">
										<select class="form-control validate[notempty]" id="organization" 
											th:field="*{organization.id}"
											data-bv-notempty="true" 
											th:attr="data-bv-notempty-message=#{error-required(#{organization})}">
											<option value=""></option>
											<option th:each="org : ${allSubOrganizations}" th:value="${org.id}" th:text="${org.nameLocal}"></option>
										</select>
									</div>
								</div>
							</div>
							<div class="col-md-6" th:if="${mode == 'viewPerson' OR mode == 'editPerson'}">
								<div class="form-group">
									<label class="col-sm-3 control-label" th:inline="text">[[#{person.appWideUniqueId}]]</label>
									<div class="col-sm-7">
										<input th:field="*{appWideUniqueId}" 
											readonly="true"
											class="form-control" />
									</div>
								</div>		
							</div>					
						</div>
						<legend></legend>
						
						<!-- REAL ############################################################################### -->
						<div id="realPersonFragment">
							<div class="row">
							<!-- real person column 1 ################################################################################# -->
								<div class="col-md-6">
									<div class="form-group">
										<label class="col-sm-3 control-label" th:inline="text">[[#{person.prefix}]]</label>
										<div class="col-sm-7">
											<input th:field="*{prefix}" 
												th:readonly="${mode == 'viewPerson'}"
												type="hidden" 
												id="realPersonPrefix" 
												class="form-control"/>
										</div>
									</div>
									<div class="form-group">
										<label class="col-sm-3 control-label" th:inline="text">[[#{person.gender}]]<span class="reqired"> *</span></label>
										<div class="col-sm-7">
											<select th:field="*{gender}" 
												class="form-control validate[notempty]" 
												data-bv-notempty="true" 
												th:attr="data-bv-notempty-message=#{error-required(#{person.gender})}">
												<option selected="selected" value=""></option>
												<option th:each="type : ${T(com.parvanpajooh.personmanagement.model.enums.Gender).values()}" th:value="${#strings.toUpperCase(type)}"
													th:text="#{gender.__${#strings.toLowerCase(type.toString())}__}"></option>
											</select>
										</div>
									</div>
									<div class="form-group">
										<label class="col-sm-3 control-label" th:inline="text">[[#{person.firstNameLocal}]]<span class="reqired"> *</span></label>
										<div class="col-sm-7">
											<input th:field="*{firstNameLocal}" 
												th:readonly="${mode == 'viewPerson'}"
												class="form-control validate[notempty]" 
												data-bv-notempty="true" 
												th:attr="data-bv-notempty-message=#{error-required(#{person.firstNameLocal})}"/>
										</div>
									</div>
									<div class="form-group">
										<label class="col-sm-3 control-label" th:inline="text">[[#{person.lastNameLocal}]]<span class="reqired"> *</span></label>
										<div class="col-sm-7">
											<input th:field="*{lastNameLocal}" 
												th:readonly="${mode == 'viewPerson'}"
												class="form-control validate[notempty]" 
												data-bv-notempty="true" 
												th:attr="data-bv-notempty-message=#{error-required(#{person.lastNameLocal})}"/>
										</div>
									</div>		
									<div class="form-group">
										<label class="col-sm-3 control-label" th:text="#{person.nickNameLocal}"></label>
										<div class="col-sm-7">
											<input class="form-control" th:field="*{nickNameLocal}" th:readonly="${mode == 'viewPerson'}"/>
										</div>
									</div>		
									<div class="form-group">
										<label class="col-sm-3 control-label" th:text="#{person.suffixLocal}"></label>
										<div class="col-sm-7">
											<input class="form-control" th:field="*{suffixLocal}" th:readonly="${mode == 'viewPerson'}"/>
										</div>
									</div>
									<div class="form-group">
										<label class="col-sm-3 control-label" th:text="#{person.firstNameEn}"></label>
										<div class="col-sm-7">
											<input class="form-control" th:field="*{firstNameEn}" th:readonly="${mode == 'viewPerson'}"/>
										</div>
									</div>
									<div class="form-group">
										<label class="col-sm-3 control-label" th:text="#{person.lastNameEn}"></label>
										<div class="col-sm-7">
											<input class="form-control" th:field="*{lastNameEn}" th:readonly="${mode == 'viewPerson'}"/>
										</div>
									</div>	

								</div>
								<!-- real person column 2 ################################################################################# -->
								<div class="col-md-6">
								
									<div class="form-group">
										<label class="col-sm-3 control-label" th:text="#{person.suffixEn}"></label>
										<div class="col-sm-7">
											<input class="form-control" th:field="*{suffixEn}" th:readonly="${mode == 'viewPerson'}"/>
										</div>
									</div>
									<div class="form-group">
										<label class="col-sm-3 control-label" th:text="#{person.nickNameEn}"></label>
										<div class="col-sm-7">
											<input class="form-control" th:field="*{nickNameEn}" th:readonly="${mode == 'viewPerson'}"/>
										</div>
									</div>									
									<div class="form-group">
										<label class="col-sm-3 control-label" th:text="#{person.idNumber}"></label>
										<div class="col-sm-7">
											<input class="form-control" th:field="*{issueId}" th:readonly="${mode == 'viewPerson'}"/>
										</div>
									</div>
									<div class="form-group">
										<label class="col-sm-3 control-label" th:inline="text">[[#{person.nationalCode}]]<span class="reqired"> *</span></label>
										<div class="col-sm-7">
											<input th:field="*{nationalId}" 
												th:readonly="${mode == 'viewPerson'}"
												class="form-control validate[notempty]" 
												data-bv-notempty="true" 
												data-bv-nationalId="true" 
												th:attr="data-bv-notempty-message=#{error-required(#{person.nationalCode})} ,data-bv-nationalId-message=#{error-nationalId(#{person.nationalCode})}"/>
										</div>
									</div>									
									<div class="form-group">
										<label class="col-sm-3 control-label" th:text="#{person.issueDate}"></label>
										<div class="col-sm-7">
											<input class="form-control datePicker" th:field="*{issueDate}" th:readonly="${mode == 'viewPerson'}"/>
										</div>
									</div>
									<div class="form-group">
										<label class="col-sm-3 control-label" th:text="#{person.issueLocation}"></label>
										<div class="col-sm-7">
											<input class="form-control" th:field="*{issueLocation}" th:readonly="${mode == 'viewPerson'}"/>
										</div>
									</div>	
									<div class="form-group">
										<label class="col-sm-3 control-label" th:text="#{person.remarks}"></label>
										<div class="col-sm-7">
											<textarea class="form-control" th:field="*{remarks}" th:readonly="${mode == 'viewPerson'}"/>
										</div>
									</div>									
								</div>
							</div>
						</div>
						
						<!-- LEGAL ############################################################################### -->
						<div id="legalPersonFragment">
							<div class="row">
							<!-- legal person column 1 ################################################################################# -->
								<div class="col-md-6">
									<div class="form-group">
										<label class="col-sm-3 control-label" th:inline="text">[[#{person.prefix}]]<span class="reqired"> *</span></label>
										<div class="col-sm-7">
											<input th:field="*{prefix}" type="hidden" id="legalPersonPrefix"
												th:readonly="${mode == 'viewPerson'}"
												class="form-control validate[notempty]" 
												data-bv-notempty="true" 
												th:attr="data-bv-notempty-message=#{error-required(#{person.prefix})}"/>
										</div>
									</div>
									<div class="form-group">
										<label class="col-sm-3 control-label" th:inline="text">[[#{person.firstNameLocal}]]<span class="reqired"> *</span></label>
										<div class="col-sm-7">
											<input th:field="*{firstNameLocal}" 
												th:readonly="${mode == 'viewPerson'}"
												class="form-control validate[notempty]" 
												data-bv-notempty="true" 
												th:attr="data-bv-notempty-message=#{error-required(#{person.firstNameLocal})}"/>
										</div>
									</div>
									<div class="form-group">
										<label class="col-sm-3 control-label" th:text="#{person.nickNameLocal}"></label>
										<div class="col-sm-7">
											<input class="form-control" th:field="*{nickNameLocal}" th:readonly="${mode == 'viewPerson'}"/>
										</div>
									</div>									
									<div class="form-group">
										<label class="col-sm-3 control-label" th:text="#{person.firstNameEn}"></label>
										<div class="col-sm-7">
											<input class="form-control" th:field="*{firstNameEn}" th:readonly="${mode == 'viewPerson'}"/>
										</div>
									</div>
									<div class="form-group">
										<label class="col-sm-3 control-label" th:text="#{person.nickNameEn}"></label>
										<div class="col-sm-7">
											<input class="form-control" th:field="*{nickNameEn}" th:readonly="${mode == 'viewPerson'}"/>
										</div>
									</div>							
									<div class="form-group">
										<label class="col-sm-3 control-label" th:text="#{person.registrationNumber}"></label>
										<div class="col-sm-7">
											<input class="form-control" th:field="*{issueId}" th:readonly="${mode == 'viewPerson'}"/>
										</div>
									</div>											
								</div>
								<!-- legal person column 2 ################################################################################# -->
								<div class="col-md-6">
									<div class="form-group">
										<label class="col-sm-3 control-label" th:inline="text">[[#{person.nationalId}]]<span class="reqired"> *</span></label>
										<div class="col-sm-7">
											<input th:field="*{nationalId}" 
												th:readonly="${mode == 'viewPerson'}"
												class="form-control" 
												data-bv-notempty="true"
												data-bv-nationalId="true" 
												th:attr="data-bv-notempty-message=#{error-required(#{person.nationalId})} ,data-bv-nationalId-message=#{error-nationalId(#{person.nationalId})}"/>
										</div>
									</div>
									<div class="form-group">
										<label class="col-sm-3 control-label" th:inline="text">[[#{person.economicCode}]]</label>
										<div class="col-sm-7">
											<input th:field="*{economicCode}" 
												th:readonly="${mode == 'viewPerson'}"
												class="form-control"/>
										</div>
									</div>									
									<div class="form-group">
										<label class="col-sm-3 control-label" th:text="#{person.registrationDate}"></label>
										<div class="col-sm-7">
											<input class="form-control datePicker" th:field="*{issueDate}" th:readonly="${mode == 'viewPerson'}"/>
										</div>
									</div>	
									<div class="form-group">
										<label class="col-sm-3 control-label" th:text="#{person.registrationLocation}"></label>
										<div class="col-sm-7">
											<input class="form-control" th:field="*{issueLocation}" th:readonly="${mode == 'viewPerson'}"/>
										</div>
									</div>	
									<div class="form-group">
										<label class="col-sm-3 control-label" th:text="#{person.remarks}"></label>
										<div class="col-sm-7">
											<textarea class="form-control" th:field="*{remarks}" th:readonly="${mode == 'viewPerson'}"/>
										</div>
									</div>
								</div>
							</div>
						</div>
						<legend></legend>

						<!-- CONTACT ############################################################################### -->
						<div id="contactInfoFragment" style="margin-top: 60px">
							<div class="row">
								<!-- column 1 ############################################################################### -->
								<div class="col-md-6">
									<div class="form-group">
										<label class="col-sm-3 control-label" th:inline="text">[[#{contactInfo.tel}]]<span class="reqired"> *</span></label>
										<div class="col-sm-7">
											<div class="input-group">
												<input th:field="*{primaryContactInfo.tel}" 
													th:readonly="${mode == 'viewPerson'}"
													class="form-control validate[notempty]" 
													data-bv-notempty="true" 
													th:attr="data-bv-notempty-message=#{error-required(#{contactInfo.tel})}"/>
												<span class="input-group-addon">
													<i class="fa fa-phone"></i>
												</span>
											</div>
										</div>
									</div>
									<div class="form-group">
										<label class="col-sm-3 control-label" th:inline="text" id="mobileLabel">[[#{contactInfo.mobile}]]</label>
										<div class="col-sm-7">
											<div class="input-group">
												<input th:field="*{primaryContactInfo.mobile}" id="mobile"
													th:readonly="${mode == 'viewPerson'}"
													class="form-control validate[notempty]" 
													data-bv-notempty="true" 
													th:attr="data-bv-notempty-message=#{error-required(#{contactInfo.mobile})}"/>
												<span class="input-group-addon">
													<i class="fa fa-mobile-phone"></i>
												</span>
											</div>
										</div>
									</div>
									<div class="form-group">
										<label class="col-sm-3 control-label" th:text="#{contactInfo.fax}"></label>
										<div class="col-sm-7">
											<div class="input-group">
												<input class="form-control" th:field="*{primaryContactInfo.fax}" th:readonly="${mode == 'viewPerson'}"/>
												<span class="input-group-addon">
													<i class="fa fa-fax"></i>
												</span>
											</div>
										</div>
									</div>
									<div class="form-group">
										<label class="col-sm-3 control-label" th:text="#{contactInfo.email}"></label>
										<div class="col-sm-7">
											<div class="input-group">
												<input class="form-control" th:field="*{primaryContactInfo.email}" th:readonly="${mode == 'viewPerson'}" 
												type ="email"
												th:attr="data-bv-emailaddress-message=#{error-email}"/>
												<span class="input-group-addon">
													<i class="fa fa-at"></i>
												</span>
											</div>
										</div>
									</div>									
								</div>
								<!-- column 2 ############################################################################### -->
								<div class="col-md-6">
								<div class="form-group">
										<label class="col-sm-3 control-label" th:inline="text">[[#{contactInfo.city}]]<span class="reqired"> *</span></label>
										<div class="col-sm-7">
											<input type="hidden" th:field="*{primaryContactInfo.cityCode}" id="primaryContactInfoCityCode" 
													th:readonly="${mode == 'viewPerson'}"
													class="form-control validate[notempty]"
													data-bv-notempty="true" 
													th:attr="data-bv-notempty-message=#{error-required(#{contactInfo.city})}">
											</input>
										</div>
									</div>
									<div class="form-group">
										<label class="col-sm-3 control-label" th:inline="text" id="postalCodeLabel">[[#{contactInfo.postalCode}]]</label>
										<div class="col-sm-7">
											<input th:field="*{primaryContactInfo.postalCode}" id="postalCode"
													th:readonly="${mode == 'viewPerson'}"
													class="form-control"
													data-bv-notempty="true" 
													th:attr="data-bv-notempty-message=#{error-required(#{contactInfo.postalCode})}"/>
										</div>
									</div>
									<div class="form-group">
										<label class="col-sm-3 control-label" th:inline="text">[[#{contactInfo.address}]]<span class="reqired"> *</span></label>
										<div class="col-sm-7">
											<textarea th:field="*{primaryContactInfo.address}" 
													th:readonly="${mode == 'viewPerson'}"
													class="form-control validate[notempty]" 
													data-bv-notempty="true" 
													th:attr="data-bv-notempty-message=#{error-required(#{contactInfo.address})}"/>
										</div>
									</div>
								</div>
							</div>
						</div>
						<!-- END   ################################################################################# -->
						</form>
					</div>
				</div>
			
			<div class="row" th:if="${mode == 'viewPerson'}">
				<div class="col-md-6">
					<div class="box box-primary">
						<div class="box-header">
							<h3 class="box-title">
								<i class="fa fa-arrow-circle-o-right"></i> Related From
							</h3>
							<div class="box-tools pull-right">
								<button th:if="${person.id}" class="btn btn-xs btn-success" onclick="createFromRelation();" th:text="#{relation.create}">Add Related From</button>
							</div>
						</div>
						<div class="box-body">
							<div class="table-responsive">
								<table class="table table-striped" id="fromRelationTable">
									<tr>
										<th class="text-center">Full name</th>
										<th class="text-center">Type</th>
										<th class="text-center">Description</th>
										<th class="text-center">Status</th>
										<th class="text-center">Actions</th>
									</tr>
									<tbody>
										<tr th:each="relation : ${person.relatesFrom}" class="text-center">
											<td th:text="${relation.fromPerson.fullNameLocal}">full name</td>
											<td th:text="${relation.type}">Type</td>
											<td th:text="${relation.description}">description</td>
											<td>
												<div th:if="${relation.active == true}" class="text-center"><i class="fa fa-check-circle fa-2x text-success"></i></div>
												<div th:if="${relation.active == false}" class="text-center"><i class="fa fa-minus-circle fa-2x text-danger"></i></div>
											</td>
											<td>
												<div style="white-space: nowrap; text-align: center;">
													<a class="btn btn-xs btn-dropbox" th:href="@{'/person/view/'+ ${relation.fromPerson.id}}" data-toggle="tooltip" data-placement="top" title="view"><i class="fa fa-eye"></i></a>
													<a class="btn btn-xs btn-primary" th:title="#{relation.modify}" href="javascript:;" th:onclick="${'modifyFromRelation('+relation.id+')'}"><i class="fa fa-pencil"></i></a>
												</div>
											</td>
										</tr>
									</tbody>
								</table>
							</div>
						</div>
					</div>
				</div>
				<div class="col-md-6">
					<div class="box box-primary">
						<div class="box-header">
							<h3 class="box-title">
								<i class="fa fa-arrow-circle-o-right"></i> Related To
							</h3>
							<div class="box-tools pull-right">
								<button th:if="${person.id}" class="btn btn-xs btn-success" onclick="createToRelation();" th:text="#{relation.create}">Add Related To</button>
							</div>
						</div>
						<div class="box-body">
							<div class="table-responsive">
								<table class="table table-striped" id="toRelationTable">
									<thead>
										<tr>
											<th class="text-center">Full name</th>
											<th class="text-center">Type</th>
											<th class="text-center">Description</th>
											<th class="text-center">Status</th>
											<th class="text-center">Actions</th>
										</tr>
									</thead>
									<tbody>
										<tr th:each="relation : ${person.relatesTo}" class="text-center">
											<td th:text="${relation.toPerson.fullNameLocal}">full name</td>
											<td th:text="${relation.type}">Type</td>
											<td th:text="${relation.description}">description</td>
											<td>
												<div th:if="${relation.active == true}" class="text-center"><i class="fa fa-check-circle fa-2x text-success"></i></div>
												<div th:if="${relation.active == false}" class="text-center"><i class="fa fa-minus-circle fa-2x text-danger"></i></div>
											</td>
											<td>
												<div style="white-space: nowrap; text-align: center;">
													<a class="btn btn-xs btn-dropbox" th:href="@{'/person/view/'+ ${relation.toPerson.id}}" data-toggle="tooltip" data-placement="top" title="view"><i class="fa fa-eye"></i></a>
													<a class="btn btn-xs btn-primary" th:title="#{relation.modify}" href="javascript:;" th:onclick="${'modifyToRelation('+relation.id+')'}"><i class="fa fa-pencil"></i></a>
												</div>
											</td>
										</tr>
									</tbody>
								</table>
							</div>
						</div>
					</div>
				</div>
			</div>
			
			<div class="modal fade" id="createToRelationModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
		        <div class="modal-dialog">
		            <div class="modal-content">
		                <div class="modal-header">
		                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
		                    <h4 class="modal-title" th:text="#{relation.create}">جدید</h4>
		                </div>
		                <form class="form-horizontal" role="form" id="createToRelationForm" method="post" action="/personmanagement-web/person/relation/save">
			                <div class="modal-body">
			                    <div class="modal-form-content">
								        <div class="callout callout-danger hide">
								            <h4></h4>
								        </div><input type="hidden" name="fromPerson.id" />
								        <div class="form-group "><label class="col-sm-2 control-label" for="type" th:text="#{person.type}">نوع</label>
								            <div class="col-sm-7"><select class="form-control " id="typeCreateTo" name="type" width="150" style="width:150px">
								            <option value=""></option><option value="BROKER">Broker</option><option value="BRANCH">Branch</option></select></div>
								        </div>
								        <div class="form-group "><label class="col-sm-2 control-label" for="toPerson.id" th:text="#{relation.toPerson}">با شخص<span class="reqired"> *</span></label>
								            <div class="col-sm-7"><input class="form-control validate[notempty]" type="hidden" name="toPerson.id" id="toPersonidCreateTo" width="300" style="width:300px" data-bv-notempty="true" data-bv-notempty-message="با شخص مورد نیاز است" /></div>
								        </div>
								        <div class="form-group "><label class="col-sm-2 control-label" for="validFrom" th:text="#{relation.validFrom}">اعتبار از</label>
								            <div class="col-sm-7"><input class="form-control persianDatePicker" id="validFromCreateTo" name="validFrom" type="text" width="100" style="width:100px" /></div>
								        </div>
								        <div class="form-group "><label class="col-sm-2 control-label" for="validTo" th:text="#{relation.validTo}">اعتبار تا</label>
								            <div class="col-sm-7"><input class="form-control persianDatePicker" id="validToCreateTo" name="validTo" type="text" width="100" style="width:100px" /></div>
								        </div>
								        <div class="form-group "><label class="col-sm-2 control-label" for="description" th:text="#{relation.description}">توضیحات</label>
								            <div class="col-sm-7"><textarea class="form-control " id="descriptionCreateTo" name="description"></textarea></div>
								        </div>
								        <div class="form-group "><label class="col-sm-2 control-label" for="active" th:text="#{relation.active}">فعال</label>
								            <div class="col-sm-7"><input class="form-control " id="active_0" name="active" type="checkbox" value="true" /></div>
								        </div>
								</div>
			                </div>
			                <div class="modal-footer checkbox">
			                	<label class="create-another" for="createToRelation-create-another">
			                		<input type="checkbox" id="createToRelation-create-another" value="true"/>
			                		<span th:text="#{create-another}" th:remove="tag">Create another</span>
			                	</label>
			                	
			                    <button type="button" class="btn btn-primary" th:text="#{button.save}">Save</button>
			                    <button type="button" class="btn btn-default" data-dismiss="modal" th:text="#{button.cancel}">Close</button>
			                </div>
		                </form>
		            </div>
		        </div>
		    </div>
			
			<div class="modal fade" id="modifyToRelationModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
		        <div class="modal-dialog">
		            <div class="modal-content">
		                <div class="modal-header">
		                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
		                    <h4 class="modal-title" th:text="#{relation.modify}">ویرایش اطلاعات</h4>
		                </div>
		                <div class="modal-body">
		                    <dy:form entity="Relation" form="modifyTo" type="modify"/>
		                </div>
		                <div class="modal-footer">
		                    <button type="button" class="btn btn-primary" th:text="#{button.save}" id="modifyToRelationBtn">Save</button>
		                    <button type="button" class="btn btn-default" data-dismiss="modal" th:text="#{button.cancel}">Close</button>
		                </div>
		            </div>
		        </div>
		    </div>
			
			<div class="modal fade" id="createFromRelationModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
		        <div class="modal-dialog">
		            <div class="modal-content">
		                <div class="modal-header">
		                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
		                    <h4 class="modal-title" th:text="#{relation.create}">جدید</h4>
		                </div>
		                <div class="modal-body">
		                    <div class="modal-form-content">
							    <form class="form-horizontal" role="form" id="createFromRelationForm" method="post" action="/personmanagement-web/personmanagement-web/person/relation/save">
							        <div class="callout callout-danger hide">
							            <h4></h4>
							        </div><input type="hidden" name="toPerson.id" />
							        <div class="form-group "><label class="col-sm-2 control-label" for="type" th:text="#{person.type}">نوع</label>
							            <div class="col-sm-7"><select class="form-control " id="typeCreateFrom" name="type" width="150" style="width:150px">
							            <option value=""></option><option value="BROKER">Broker</option><option value="BRANCH">Branch</option></select></div>
							        </div>
							        <div class="form-group "><label class="col-sm-2 control-label" for="fromPerson.id" th:text="#{relation.fromPerson}">از شخص<span class="reqired"> *</span></label>
							            <div class="col-sm-7"><input class="form-control validate[notempty]" type="hidden" name="fromPerson.id" id="fromPersonidCreateFrom" width="300" style="width:300px" data-bv-notempty="true" data-bv-notempty-message="از شخص مورد نیاز است" /></div>
							        </div>
							        <div class="form-group "><label class="col-sm-2 control-label" for="validFrom" th:text="#{relation.validFrom}">اعتبار از</label>
							            <div class="col-sm-7"><input class="form-control persianDatePicker" id="validFromCreateFrom" name="validFrom" type="text" width="100" style="width:100px" /></div>
							        </div>
							        <div class="form-group "><label class="col-sm-2 control-label" for="validTo" th:text="#{relation.validTo}">اعتبار تا</label>
							            <div class="col-sm-7"><input class="form-control persianDatePicker" id="validToCreateFrom" name="validTo" type="text" width="100" style="width:100px" /></div>
							        </div>
							        <div class="form-group "><label class="col-sm-2 control-label" for="description" th:text="#{relation.description}">توضیحات</label>
							            <div class="col-sm-7"><textarea class="form-control " id="descriptionCreateFrom" name="description"></textarea></div>
							        </div>
							        <div class="form-group "><label class="col-sm-2 control-label" for="active" th:text="#{relation.active}">فعال</label>
							            <div class="col-sm-7"><input class="form-control " id="active_0" name="active" type="checkbox" value="true" /></div>
							        </div>
							    </form>
							</div>
		                </div>
		                <div class="modal-footer checkbox">
		                	<label class="create-another" for="createFromRelation-create-another">
		                		<input type="checkbox" id="createFromRelation-create-another" value="true"/>
		                		<span th:text="#{create-another}" th:remove="tag">Create another</span>
		                	</label>
		                	
		                    <button type="button" class="btn btn-primary" th:text="#{button.save}">Save</button>
		                    <button type="button" class="btn btn-default" data-dismiss="modal" th:text="#{button.cancel}">Close</button>
		                </div>
		            </div>
		        </div>
		    </div>
			
			<div class="modal fade" id="modifyFromRelationModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
		        <div class="modal-dialog">
		            <div class="modal-content">
		                <div class="modal-header">
		                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
		                    <h4 class="modal-title" th:text="#{relation.modify}">ویرایش اطلاعات</h4>
		                </div>
		                <div class="modal-body">
		                    <dy:form entity="Relation" form="modifyFrom" type="modify"/>
		                </div>
		                <div class="modal-footer">
		                    <button type="button" class="btn btn-primary" th:text="#{button.save}" id="modifyFromRelationBtn">Save</button>
		                    <button type="button" class="btn btn-default" data-dismiss="modal" th:text="#{button.cancel}">Close</button>
		                </div>
		            </div>
		        </div>
		    </div>
		</section>
		
		<th:block layout:fragment="javascripts">
			<script th:inline="javascript">

			var titleModifyRelation = '<span class="label label-info"  th:remove="tag" th:text="#{relation.modify}">Modify Relation !</span>';
			
			var legalPrefix = [
				{id:'company', text: /*[[#{person.prefix.company}]]*/ 
				},
				{id:'institution', text: /*[[#{person.prefix.institution}]]*/ 
				},
				{id:'office', text: /*[[#{person.prefix.office}]]*/ 
				},
				{id:'organization', text: /*[[#{person.prefix.organization}]]*/ 
				},
				{id:'ministry', text: /*[[#{person.prefix.ministry}]]*/ 
				},
				{id:'representative', text: /*[[#{person.prefix.representative}]]*/ 
				},
				{id:'laboratory', text: /*[[#{person.prefix.laboratory}]]*/ 
				},
				{id:'hospital', text: /*[[#{person.prefix.hospital}]]*/ 
				},
				{id:'clinic', text: /*[[#{person.prefix.clinic}]]*/ 
				},
				{id:'union', text: /*[[#{person.prefix.union}]]*/ 
				},
				{id:'community', text: /*[[#{person.prefix.community}]]*/ 
				},
				{id:'garrison', text: /*[[#{person.prefix.garrison}]]*/ 
				},
				{id:'cooperative', text: /*[[#{person.prefix.cooperative}]]*/ 
				},
				{id:'bank', text: /*[[#{person.prefix.bank}]]*/ 
				}
			];

			var realPrefix = [
   				{id:'dr', text: /*[[#{person.prefix.dr}]]*/ 
   				},
   				{id:'ng', text: /*[[#{person.prefix.ng}]]*/ 
   				}
   			];
   			
			var currentPersonId = /*[[${person.id}]]*/;
			//var currentPersonUrl =

   	    	$('input[type=radio][name=type]').on('ifChanged', function() {
   	   	    	
   	    		if (this.checked) {
   	    			var $legalPersonFragment = $('#legalPersonFragment');
   	    			var $realPersonFragment = $('#realPersonFragment');
   	    			var $contactInfoFragment = $('#contactInfoFragment');
   	    			if (this.value == 'REAL') {
   	    				$("#legalPersonFragment :input").prop("disabled", true);
   	    				$("#realPersonFragment :input").prop("disabled", false);
   	    				$('#realPersonFragment').css('display','block');
   	    				$('#legalPersonFragment').css('display','none');
   	    				
   	    				$('#legalPersonFragment').find('[data-bv-field]').each(function() {
   	    					$legalPersonFragment.bootstrapValidator('removeField', this.name);
   	    				});
   	    				$('#realPersonFragment').find('[data-bv-field]').each(function() {
   	    					$realPersonFragment.bootstrapValidator('addField', this.name);
   	    				});
   	    				$contactInfoFragment.bootstrapValidator('destroy');
   	    				$contactInfoFragment.bootstrapValidator({
	   						excluded: [':disabled'], 
	   						feedbackIcons:{valid: 'fa fa-check',invalid: 'fa fa-times',validating: 'fa fa-refresh'}
   						});
 	    				$realPersonFragment.bootstrapValidator('addField', $('#createPersonForm').find('#organization'));
 	    				$contactInfoFragment.bootstrapValidator('addField', $('#createPersonForm').find('#mobile'));
 	    				$contactInfoFragment.bootstrapValidator('removeField', $('#createPersonForm').find('#postalCode'));
   	    				resetLegalPersonFragment($legalPersonFragment);
   	    				$('#mobileLabel span').remove();
   	    				$('#mobileLabel').append('<span class="reqired"> *</span>');
   	    				$('#postalCodeLabel span').remove();
   	    				
   	    			} else if (this.value == 'LEGAL') {
   	    				$("#legalPersonFragment :input").prop("disabled", false);
   	    				$("#realPersonFragment :input").prop("disabled", true);
   	    				$('#realPersonFragment').css('display','none');
   	    				$('#legalPersonFragment').css('display','block');
   	    				$('#realPersonFragment').find('[data-bv-field]').each(function() {
   	    					$realPersonFragment.bootstrapValidator('removeField', this.name);
   	    				});
   	    				$('#legalPersonFragment').find('[data-bv-field]').each(function() {
   	    					$legalPersonFragment.bootstrapValidator('addField', this.name);
   	    				});
   	    				$contactInfoFragment.bootstrapValidator('destroy');
   	    				$contactInfoFragment.bootstrapValidator({
	   						excluded: [':disabled'], 
	   						feedbackIcons:{valid: 'fa fa-check',invalid: 'fa fa-times',validating: 'fa fa-refresh'}
   						});
   	    				$legalPersonFragment.bootstrapValidator('addField', $('#createPersonForm').find('#organization'));
   	    				$contactInfoFragment.bootstrapValidator('removeField', $('#createPersonForm').find('#mobile'));
   	    				$contactInfoFragment.bootstrapValidator('addField', $('#createPersonForm').find('#postalCode'));
   	    				resetRealPersonFragment($realPersonFragment);
   	    				$('#postalCodeLabel span').remove();
   	    				$('#postalCodeLabel').append('<span class="reqired"> *</span>');
   	    				$('#mobileLabel span').remove();
   	    			}
   	    		}
   	    	});

		    $(document).ready(function() {
		    	 
				$('#legalPersonFragment ,#realPersonFragment ,#contactInfoFragment ,#createToRelationForm ,#createFromRelationForm').bootstrapValidator({
					excluded: [':disabled'], 
					feedbackIcons:{
						valid: 'fa fa-check',
						invalid: 'fa fa-times',
						validating: 'fa fa-refresh'
					}
				});

				$('#createFromRelationModal').on('hidden.bs.modal', function () {
					$('#createFromRelationForm').data('bootstrapValidator').resetForm();
				});
				
				$('.modal').on('shown.bs.modal', function() {
				    $(this).find('input[type=text],textarea,select').filter(':visible:first').focus();
				    $('.modal .modal-body').css('overflow-y', 'auto');
				    $('.modal .modal-body').css('max-height', $(window).height() * 0.7);
				});

		    	$('#realPersonPrefix').select2({
		    		id: function(obj) { return obj.text; },
		    		placeholder: [[#{choose}]],
		    		allowClear: true,
		    		data: realPrefix,
		    	    formatSelection: function(item){return item.text },
		    	    formatResult: function(item){return item.text },
		    	    initSelection: function (element, callback) {
		    	        var data = {id: element.val(), text: element.val()};
		    	        callback(data);
		    	    }
		    	}).change(function() {
					$('#realPersonFragment').data('bootstrapValidator').updateStatus('prefix', 'NOT_VALIDATED', null).validateField('prefix');
				});
		    	
		    	$('#legalPersonPrefix').select2({
		    		id: function(obj) { return obj.text; },
		    		placeholder: [[#{choose}]],
		    		allowClear: true,
		    		data: legalPrefix,
		    	    formatSelection: function(item){return item.text },
		    	    formatResult: function(item){return item.text },
		    	    initSelection: function (element, callback) {
		    	        var data = {id: element.val(), text: element.val()};
		    	        callback(data);
		    	    }
		    	}).change(function() {
					$('#legalPersonFragment').data('bootstrapValidator').updateStatus('prefix', 'NOT_VALIDATED', null).validateField('prefix');
				});

		    	$('#gender , #organization , #typeCreateTo , #typeCreateFrom').select2({
	    			placeholder: [[#{choose}]]
	    			,allowClear: true,
	    			
    			});

		    	/*<![CDATA[*/
		    	$('#primaryContactInfoCityCode').select2({
	    				placeholder: [[#{choose}]]
	    				,formatResult: geoEntityFormat
	    				,id: function(obj) { return obj.shortCode; }
	    				,formatSelection: geoEntityFormat
	    				,initSelection: geoEntityInitSelection
	    				,allowClear: true
	    				,ajax: {
	    					 url: '/personmanagement-web/person/cities',
	    					 transport: transportFunction,
	    					 dataType: 'json',
	    					 params: {contentType: 'application/json;charset=utf-8', statusCode: {404: function(){showError('404');},403: function(){showError('403');},503: function(){showError('503');}}},
	    					 quietMillis: 200,
	    					 data: function (term, page) {
	    					 	return {
					    				'columns[1][data]': 'id'
					    				,start: (page - 1) * 20
					    				,length: 20
					    				,'order[1][column]': 1
					    				,'order[1][dir]': 'asc'
					    				,term: term
	    					 	};
	    					 },
	    					 results: function (data, page) {
	    					 	var more = (page * 20) < data.recordsFiltered;
	    					 	return {results: data.data, more: more}
	    					 }
	    				}
  				}).change(function() {
					$('#contactInfoFragment').data('bootstrapValidator').updateStatus('primaryContactInfo.cityCode', 'NOT_VALIDATED', null).validateField('primaryContactInfo.cityCode');
				});
				
				$('#toPersonidCreateTo').select2({
				    placeholder: [[#{choose}]],
				    formatResult: personFormat,
				    id: function(obj) {
				        return obj.id;
				    },
				    formatSelection: personFormat,
				    initSelection: personInitSelection,
				    allowClear: true,
				    ajax: {
				        url: '/personmanagement-web/person/paging',
				        transport: transportFunction,
				        dataType: 'json',
				        params: {
				            contentType: 'application/json;charset=utf-8',
				            statusCode: {404: function() {showError('404');},403: function() {showError('403');},503: function() {showError('503');}}
				        },
				        quietMillis: 200,
				        data: function(term, page) {
				            return {
				                'columns[1][data]': 'id',
				                start: (page - 1) * 20,
				                length: 20,
				                'order[1][column]': 1,
				                'order[1][dir]': 'asc',
				                allNames: term
				            };
				        },
				        results: ajaxResult
				    }

				}).change(function() {
				    $('#createToRelationForm').data('bootstrapValidator').updateStatus('toPerson.id', 'NOT_VALIDATED', null).validateField('toPerson.id');
				});

				$('#fromPersonidCreateFrom').select2({
				    placeholder: [[#{choose}]],
				    formatResult: personFormat,
				    id: function(obj) {
				        return obj.id;
				    },
				    formatSelection: personFormat,
				    initSelection: personInitSelection,
				    allowClear: true,
				    ajax: {
				        url: '/personmanagement-web/person/paging',
				        transport: transportFunction,
				        dataType: 'json',
				        params: {
				            contentType: 'application/json;charset=utf-8',
				            statusCode: {404: function() {showError('404');},403: function() {showError('403');},503: function() {showError('503');}}
				        },
				        quietMillis: 200,
				        data: function(term, page) {
				            return {
				                'columns[1][data]': 'id',
				                start: (page - 1) * 20,
				                length: 20,
				                'order[1][column]': 1,
				                'order[1][dir]': 'asc',
				                allNames: term
				            };
				        },
				        results: ajaxResult
				    }

				}).change(function() {
				    $('#createFromRelationForm').data('bootstrapValidator').updateStatus('fromPerson.id', 'NOT_VALIDATED', null).validateField('fromPerson.id');
				});

			    if([[${mode == 'createPerson'}]]){
	    	 		$('input[name="type"][value="REAL"]').iCheck('check').iCheck('enable').trigger('ifChanged');
			    }else if ([[${mode == 'viewPerson'}]]){
					$('input[name="type"]').trigger('ifChanged');
					$('input[name="type"]').iCheck('disable');
					$('input[name="active"]').iCheck('disable');
					$("#gender , #organization").select2("readonly", true);
			    }
				else if ([[${mode == 'editPerson'}]]){
					$('input[name="type"]').trigger('ifChanged');
			    }

		    	$('#createPersonBtn').click(function(){
		    		var $btn = $(this);
		    		var isValidForm = false;
		    		var isContactInfosValid = false;
		    		$('#createPersonForm').find('.callout').text('').addClass('hide');
    				$('#contactInfoFragment').data('bootstrapValidator').validate();
    				isContactInfosValid = $('#contactInfoFragment').data('bootstrapValidator').isValid();
    				
		    		if($('input[name="type"][value="REAL"]').is(":checked")){
		    			$('#realPersonFragment').data('bootstrapValidator').validate();
		    			isValidForm = isContactInfosValid ? $('#realPersonFragment').data('bootstrapValidator').isValid() : false;
					}else if($('input[name="type"][value="LEGAL"]').is(":checked")){
						$('#legalPersonFragment').data('bootstrapValidator').validate();
						isValidForm = isContactInfosValid ? $('#legalPersonFragment').data('bootstrapValidator').isValid() : false;
					}
					if(isValidForm){ 
		    			$btn.attr('disabled', true);
			    		$.post('/personmanagement-web/person/save/page', $('#createPersonForm').serialize()).done(function(data) {
			    			if(data.status == 'success') {
			    				showTopleftGrowl('success', 'Create', 'Create Successful');
			    				window.open("/personmanagement-web/person/", "_self");
			    			} else if(data.status == 'ValidationException'){
			    				showTopleftGrowl('error', 'Error', data.invalidField);
			    				$('#createPersonForm').find('.callout').text(data.invalidField + 'invalid-value').removeClass('hide');
			    			} else if(data.status == 'ErrorCode'){
			    				if(data.errorMessage){
			    					showTopleftGrowl('error', 'Error', data.errorMessage);
			    					$('#createPersonForm').find('.callout').text(data.errorMessage).removeClass('hide');
			    				} else {
			    					showTopleftGrowl('error', 'Error', data.errorCode);
			    					$('#createPersonForm').find('.callout').text(messages[data.errorCode]).removeClass('hide');
			    				}
			    			} else {
			    				console.debug(data.status);
			    				showTopleftGrowl('error', 'Error', data.message);
			    				$('#createPersonForm').find('.callout').text((data.message ? data.message : 'delete.failed' )).removeClass('hide');
			    			}
			    			$btn.attr('disabled', false);
			    		}).fail(function( jqXHR, textStatus, errorThrown ){failAjax(jqXHR, textStatus, errorThrown, 'createPersonBtn')});
					} 
			    		return false;
		    	});
		    	
		    });

   	    	function resetContactInfoFragment($contactInfoFragment) {
   	    		$contactInfoFragment.find('input,select, textarea').val('');
   	    		try{$('#primaryContactInfoCityCode').select2('val', '');}catch(Erro){}
   			}
   			
   	    	function resetRealPersonFragment($realPersonFragment) {
   			    $realPersonFragment.find('input:text,select, textarea').val('');
   			    $realPersonFragment.find('input:radio, input:checkbox').iCheck('uncheck');
   			 	try{$('#gender').select2('val', '');}catch(Erro){}
   			 	try{$('#realPersonPrefix').select2('val', '');}catch(Erro){}
   			}

   	    	function resetLegalPersonFragment($legalPersonFragment) {
   			    $legalPersonFragment.find('input:text,select, textarea').val('');
   			    $legalPersonFragment.find('input:radio, input:checkbox').iCheck('uncheck');
   			 	try{$('#legalPersonPrefix').select2('val', '');}catch(Erro){}
   			}
		    
		    function personInitSelection(element, callback) {
	    		var id = $(element).val();
	    		$.ajax({
	    			url : '/personmanagement-web/person/get', 
	    			data : {id : id}, 
	    			dataType: 'json'
	    		}).done(function(data) {callback(data);});
	    	}

	    	function personFormat(aaData) {
	    		return aaData.fullNameLocal; 
	    	}

	    	function ajaxResult(data, page) {
				var more = (page * 20) < data.recordsFiltered;
				$.each(data.data, function(i,obj) {
					if (/* currentPersonId == obj.id ||  */!obj.active) {
						obj.disabled = true;
						return;
					}
				});
				return {results: data.data, more: more};
			}

	    	function geoEntityFormat(aaData) {
	    		var res = '<strong>'+ aaData.nameFa +'</strong>';
	    		var resAdditional = '';
	    		if(aaData.provinceNameFa){
	    			resAdditional = aaData.provinceNameFa + ' , ';
	    			
	    			if(aaData.countryNameFa){
	    				resAdditional = aaData.countryNameFa + ' , ' + resAdditional;
	    			}
	    			
	    			res = '<span style="color: #999;">' + resAdditional + '</span>' + res;
	    		}
	    		return res; 
	    	}

		    function geoEntityInitSelection(element, callback) {
	    		var id = $(element).val();
	    		$.ajax({
	    			url : '/personmanagement-web/person/cities/' + id, 
	    			dataType: 'json'
	    		}).done(function(data) {callback(data);});
	    	}

			function createToRelationModalOnShow(){
				$('input[name="fromPerson.id"]').val(currentPersonId);
			}

			function createToRelationAfterSaveSuccess(){
				document.location.href = currentPersonUrl;
			}

			function modifyToRelationAfterSaveSuccess(){
				document.location.href = currentPersonUrl;
			}

			function createFromRelationModalOnShow(){
				$('input[name="toPerson.id"]').val(currentPersonId);
			}

			function createFromRelationAfterSaveSuccess(){
				document.location.href = currentPersonUrl;
			}

			function modifyFromRelationAfterSaveSuccess(){
				document.location.href = currentPersonUrl;
			}

			function createToRelation() {
				try{createToRelationModalBeforShow()}catch(error){}
				resetCreateToForm($('#createToRelationModal'));
				$('#createToRelationModal').modal({ backdrop: 'static', keyboard: true });
				$('#createToRelationModal').modal('show');
				$('#createToRelationForm').find('.callout').text('').addClass('hide');
				$('#createToRelationModal').find('input[type=checkbox]').attr('checked', false).iCheck({checkboxClass: "icheckbox_minimal",radioClass: "iradio_minimal"});
				$('#createToRelationModal').find('input[type=radio]').attr('checked', false).iCheck({checkboxClass: "icheckbox_minimal",radioClass: "iradio_minimal"});
				try{createToRelationModalOnShow()}catch(error){}
			}

			function resetCreateToForm(container) {
				$('#fromPersonidCreateTo').val('');
				try{$('#typeCreateTo').select2('val', '');}catch(Erro){}
				try{$('#toPersonidCreateTo').select2('val', '');}catch(Erro){}
				$('#validFromCreateTo').val('');
				$('#validToCreateTo').val('');
				$('#descriptionCreateTo').val('');
				$('#activeCreateTo').prop('checked', false);
			}

			function resetCreateFromForm(container) {
				$('#toPersonidCreateFrom').val('');
				try{$('#typeCreateFrom').select2('val', '');}catch(Erro){}
				try{$('#fromPersonidCreateFrom').select2('val', '');}catch(Erro){}
				$('#validFromCreateFrom').val('');
				$('#validToCreateFrom').val('');
				$('#descriptionCreateFrom').val('');
				$('#activeCreateFrom').prop('checked', false);
			}
			function createFromRelation() {
				try{createFromRelationModalBeforShow()}catch(error){}
				resetCreateFromForm($('#createFromRelationModal'));
				$('#createFromRelationModal').modal({ backdrop: 'static', keyboard: true });
				$('#createFromRelationModal').modal('show');
				$('#createFromRelationForm').find('.callout').text('').addClass('hide');
				$('#createFromRelationModal').find('input[type=checkbox]').attr('checked', false).iCheck({checkboxClass: "icheckbox_minimal",radioClass: "iradio_minimal"});
				$('#createFromRelationModal').find('input[type=radio]').attr('checked', false).iCheck({checkboxClass: "icheckbox_minimal",radioClass: "iradio_minimal"});
				try{createFromRelationModalOnShow()}catch(error){}
			}
			
	    	/*]]>*/
    		</script>
		</th:block>
	</body>
</html>
